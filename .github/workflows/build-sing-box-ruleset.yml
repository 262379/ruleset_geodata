name: Build build sing-box-ruleset
on:
  workflow_dispatch:
  schedule:
    - cron: "0 19 * * *"
  push:
    branches:
      - master
    paths-ignore:
      - "README.md"
      - ".github/workflows/delete-old-workflows.yml"
      - ".github/workflows/build-geox.yml"
      - ".github/workflows/build-clash-ruleset.yml"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout codebase
        uses: actions/checkout@master

      - name: Download and unzip `sing-box core`
        run: |
          echo "update_version=$(date -d '+8 hours' +%Y-%m-%d)" >> ${GITHUB_ENV}
          mkdir -p ./ruleset/sing-box/geox-all ./ruleset/sing-box/geox ./tmp/
          sing_box_version=$(curl -sSL https://api.github.com/repos/SagerNet/sing-box/releases/latest | grep 'tag_name' | sed 's/.*v//g' | sed 's/",$//g')
          wget "https://github.com/SagerNet/sing-box/releases/download/v${sing_box_version}/sing-box-${sing_box_version}-linux-amd64.tar.gz" -O - | tar -zxf - -C ./tmp/
          cp -f ./tmp/sing-box-${sing_box_version}-linux-amd64/sing-box ./ruleset/sing-box/geox-all/
          cp -f ./tmp/sing-box-${sing_box_version}-linux-amd64/sing-box ./ruleset/sing-box/geox/

      - name: Download and unzip `mosdns`
        run: |
          wget -P ./tmp/ "https://github.com/IrineSistiana/mosdns/releases/download/v4.5.3/mosdns-linux-amd64.zip"
          unzip -o "./tmp/mosdns-linux-amd64.zip" -d ./tmp/
          cp -f ./tmp/mosdns ./ruleset/sing-box/geox-all/
          cp -f ./tmp/mosdns ./ruleset/sing-box/geox/

      - name: Convert geox-all to sing-box-ruleset
        env:
          NO_SKIP: true
        run: |
          cp -f ./geox/sing-box/geosite-all.db ./ruleset/sing-box/geox-all/geosite.db
          cp -f ./geox/clash/geoip-all.dat ./ruleset/sing-box/geox-all/geoip.dat
          wget -P ./ruleset/sing-box/geox-all/ https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/master/resouces/convert.sh
          cd ./ruleset/sing-box/geox-all/
          chmod +x mosdns sing-box convert.sh && ./convert.sh
          rm -rf mosdns sing-box convert.sh geosite.db geoip.dat LICENSE README.md config.yaml

      - name: Convert geox to sing-box-ruleset
        env:
          NO_SKIP: true
        run: |
          cp -f ./geox/sing-box/geosite.db ./ruleset/sing-box/geox/
          cp -f ./geox/clash/geoip.dat ./ruleset/sing-box/geox/
          wget -P ./ruleset/sing-box/geox/ https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/master/resouces/convert.sh
          cd ./ruleset/sing-box/geox/
          chmod +x mosdns sing-box convert.sh && ./convert.sh
          rm -rf ../../../tmp* mosdns sing-box convert.sh geosite.db geoip.dat LICENSE README.md config.yaml

      - name: Commit and push
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add . && git commit -m "更新于 ${update_version}" || exit 0
          git push -f

      - name: Purge jsDelivr CDN
        run: |
          cd ./ruleset/sing-box/geox-all/geosite/ || exit 1
          for file in $(ls); do
            curl -i "https://purge.jsdelivr.net/gh/${{ github.repository }}@master/ruleset/sing-box/geox-all/geosite/${file}"
          done
          cd ../../geox/geosite/ || exit 1
          for file in $(ls); do
            curl -i "https://purge.jsdelivr.net/gh/${{ github.repository }}@master/ruleset/sing-box/geox/geosite/${file}"
          done
          cd ../geoip/ || exit 1
          for file in $(ls); do
            curl -i "https://purge.jsdelivr.net/gh/${{ github.repository }}@master/ruleset/sing-box/geox/geoip/${file}"
          done
          cd ../mixed/ || exit 1
          for file in $(ls); do
            curl -i "https://purge.jsdelivr.net/gh/${{ github.repository }}@master/ruleset/sing-box/geox/mixed/${file}"
          done
